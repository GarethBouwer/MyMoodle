From 825aa9ee4d53b64301d855488e0730f89f86e377 Mon Sep 17 00:00:00 2001
From: GarethBouwer <itservices@bouwerandco.com>
Date: Thu, 12 Feb 2026 17:08:05 +0200
Subject: [PATCH 33/33] new url + stubs

---
 .php_stubs/moodle_stubs.php                   | 34 +++++++++++++++++++
 Dockerfile                                    |  3 +-
 composer.json                                 |  3 +-
 config.php                                    | 14 +++++++-
 .../blocks/myoverview/classes/output/main.php |  8 +++--
 public/course/externallib.php                 |  4 +++
 6 files changed, 60 insertions(+), 6 deletions(-)
 create mode 100644 .php_stubs/moodle_stubs.php

diff --git a/.php_stubs/moodle_stubs.php b/.php_stubs/moodle_stubs.php
new file mode 100644
index 00000000000..5c4f187926d
--- /dev/null
+++ b/.php_stubs/moodle_stubs.php
@@ -0,0 +1,34 @@
+<?php
+// Minimal stubs to help static analysis tools (Intelephense, PHPStan, etc.)
+// These are intentionally small and only used for IDE analysis, not executed.
+
+interface renderable {}
+interface templatable {}
+class renderer_base {}
+
+class moodle_url {
+    public function __construct($path = '', $params = []) {}
+    public function out() {}
+}
+
+class single_button {
+    const BUTTON_PRIMARY = 1;
+    public function __construct($url, $label = '', $method = 'get', $extra = null) {}
+    public function export_for_template($renderer) {}
+}
+
+class moodle_exception extends \Exception {
+    public $errorcode;
+}
+
+class html_writer {
+    public static function span($text, $class = '') { return '<span class="' . $class . '">' . $text . '</span>'; }
+}
+
+class cm_info {
+    public static function create($cm) {}
+}
+
+class core_component {
+    public static function get_plugin_list($type) { return []; }
+}
diff --git a/Dockerfile b/Dockerfile
index d604d2ed393..5a23c0f08ac 100644
--- a/Dockerfile
+++ b/Dockerfile
@@ -50,7 +50,8 @@ RUN mkdir -p /var/www/moodledata \
 # Apache vhost: serve ONLY /public (Moodle 5.x requirement) and set ServerName
 RUN printf '%s\n' \
     '<VirtualHost *:80>' \
-    '    ServerName localhost' \
+    '    ServerName clementsandcox.academy' \
+    '    ServerAlias www.clementsandcox.academy' \
     '    DocumentRoot /var/www/html/public' \
     '    <Directory /var/www/html/public>' \
     '        AllowOverride All' \
diff --git a/composer.json b/composer.json
index e5d3054aae8..6971ad35e59 100644
--- a/composer.json
+++ b/composer.json
@@ -18,7 +18,8 @@
         "symfony/mime": "^4.4 || ^5.0 || ^6.0 || ^7.0",
         "behat/behat": "^3",
         "oleg-andreyev/mink-phpwebdriver": "1.3.*",
-        "filp/whoops": "^2.15"
+        "filp/whoops": "^2.15",
+        "php-stubs/moodle-stubs": "*"
     },
     "autoload-dev": {
         "psr-0": {
diff --git a/config.php b/config.php
index 0900199e5e7..64bcc4b25be 100644
--- a/config.php
+++ b/config.php
@@ -23,7 +23,7 @@ $CFG->dboptions = array(
 
 // ========= PATHS =========
 
-$CFG->wwwroot   = 'https://mymoodle-production.up.railway.app';
+$CFG->wwwroot   = 'https://clementsandcox.academy';
 $CFG->dirroot   = '/var/www/html';
 $CFG->dataroot  = '/var/www/moodledata';
 $CFG->libdir    = '/var/www/html/lib';
@@ -64,3 +64,15 @@ if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
 }
 
 require_once(__DIR__ . '/lib/setup.php');
+
+// If running via web and the request used the www subdomain, redirect
+// to the canonical non-www host so both DNS names are supported by DNS
+// while keeping a single canonical `wwwroot`.
+if (php_sapi_name() !== 'cli' && !empty($_SERVER['HTTP_HOST'])) {
+    $host = strtolower($_SERVER['HTTP_HOST']);
+    if (strpos($host, 'www.') === 0 && substr($host, 4) === 'clementsandcox.academy') {
+        $requesturi = isset($_SERVER['REQUEST_URI']) ? $_SERVER['REQUEST_URI'] : '/';
+        header('Location: https://clementsandcox.academy' . $requesturi, true, 301);
+        exit;
+    }
+}
diff --git a/public/blocks/myoverview/classes/output/main.php b/public/blocks/myoverview/classes/output/main.php
index 576aadd535b..f6baea9d61b 100644
--- a/public/blocks/myoverview/classes/output/main.php
+++ b/public/blocks/myoverview/classes/output/main.php
@@ -29,6 +29,8 @@ use renderable;
 use renderer_base;
 use templatable;
 use stdClass;
+use moodle_url;
+use single_button;
 
 require_once($CFG->dirroot . '/blocks/myoverview/lib.php');
 
@@ -38,7 +40,7 @@ require_once($CFG->dirroot . '/blocks/myoverview/lib.php');
  * @copyright  2018 Bas Brands <bas@moodle.com>
  * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
  */
-class main implements renderable, templatable {
+class main implements \renderable, \templatable {
 
     /**
      * Store the grouping preference.
@@ -410,7 +412,7 @@ class main implements renderable, templatable {
      * @throws \coding_exception
      *
      */
-    public function export_for_template(renderer_base $output) {
+    public function export_for_template(\renderer_base $output) {
         global $CFG, $USER;
 
         $nocoursesurl = $output->image_url('courses', 'block_myoverview')->out();
@@ -526,7 +528,7 @@ class main implements renderable, templatable {
      * @throws \coding_exception
      *
      */
-    public function export_for_zero_state_template(renderer_base $output) {
+    public function export_for_zero_state_template(\renderer_base $output) {
         global $CFG, $DB;
 
         $nocoursesimg = $output->image_url('courses', 'block_myoverview');
diff --git a/public/course/externallib.php b/public/course/externallib.php
index f4630111365..bf502dcc94d 100644
--- a/public/course/externallib.php
+++ b/public/course/externallib.php
@@ -39,6 +39,10 @@ use core_external\external_value;
 use core_external\external_warnings;
 use core_external\util;
 require_once(__DIR__ . "/lib.php");
+use moodle_exception;
+use html_writer;
+use cm_info;
+use core_component;
 
 /**
  * Course external functions
-- 
2.48.1.windows.1

