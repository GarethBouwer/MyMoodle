From 8cd40e3ce4e82ba4f8eccf3a159323df41d8a80c Mon Sep 17 00:00:00 2001
From: GarethBouwer <itservices@bouwerandco.com>
Date: Wed, 4 Feb 2026 11:30:48 +0200
Subject: [PATCH 17/33] please be the last docker

---
 Dockerfile | 21 +++++++++++++++++----
 1 file changed, 17 insertions(+), 4 deletions(-)

diff --git a/Dockerfile b/Dockerfile
index e23139c90ed..6d909be826d 100644
--- a/Dockerfile
+++ b/Dockerfile
@@ -1,9 +1,9 @@
 FROM php:8.1-apache
 
-# Enable Apache rewrite for clean URLs (recommended by Moodle)
+# Enable Apache rewrite (required by Moodle for clean URLs)
 RUN a2enmod rewrite
 
-# Install system deps needed for Moodle + PostgreSQL extensions
+# Install system dependencies + PHP extensions needed by Moodle
 RUN apt-get update && apt-get install -y \
     git \
     unzip \
@@ -28,16 +28,29 @@ RUN apt-get update && apt-get install -y \
         pgsql \
         pdo_pgsql \
         opcache \
+        ldap \
  && rm -rf /var/lib/apt/lists/*
 
-# Web root
+# App root
 WORKDIR /var/www/html
 
-# Copy Moodle source
+# Copy Moodle source into the image
 COPY . /var/www/html
 
 # Moodle data directory (Railway volume mounts here)
 RUN mkdir -p /var/www/moodledata \
  && chown -R www-data:www-data /var/www/html /var/www/moodledata
 
+# Configure Apache to serve only the /public directory (Moodle 5.x requirement)
+RUN printf '%s\n' \
+    '<VirtualHost *:80>' \
+    '    ServerName localhost' \
+    '    DocumentRoot /var/www/html/public' \
+    '    <Directory /var/www/html/public>' \
+    '        AllowOverride All' \
+    '        Require all granted' \
+    '    </Directory>' \
+    '</VirtualHost>' \
+    > /etc/apache2/sites-available/000-default.conf
+
 EXPOSE 80
-- 
2.48.1.windows.1

