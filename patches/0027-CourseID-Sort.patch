From 7044fe63d6f7914376337ea01e290feaa2c14c5b Mon Sep 17 00:00:00 2001
From: GarethBouwer <itservices@bouwerandco.com>
Date: Wed, 11 Feb 2026 15:06:41 +0200
Subject: [PATCH 27/33] CourseID Sort

---
 public/blocks/myoverview/classes/output/main.php            | 6 ++++++
 public/blocks/myoverview/lang/en/block_myoverview.php       | 1 +
 public/blocks/myoverview/lib.php                            | 2 ++
 .../blocks/myoverview/templates/nav-sort-selector.mustache  | 6 ++++++
 public/course/externallib.php                               | 5 +++++
 5 files changed, 20 insertions(+)

diff --git a/public/blocks/myoverview/classes/output/main.php b/public/blocks/myoverview/classes/output/main.php
index c47135b3dfc..a8c94b5bce4 100644
--- a/public/blocks/myoverview/classes/output/main.php
+++ b/public/blocks/myoverview/classes/output/main.php
@@ -475,6 +475,11 @@ class main implements renderable, templatable {
                 // $sort = 'category, idnumber';
                 break;
 
+            case BLOCK_MYOVERVIEW_SORTING_CATEGORY_IDNUMBER:
+                // Sort by the category idnumber assigned to the course's category.
+                $sort = 'categoryidnumber';
+                break;
+
             case BLOCK_MYOVERVIEW_SORTING_TITLE:
             default:
                 $sort = 'fullname';
@@ -507,6 +512,7 @@ class main implements renderable, templatable {
             'selectedcustomfield' => $selectedcustomfield,
             'showsortbyshortname' => $CFG->courselistshortnames,
             'idnumber'      => $this->sort == BLOCK_MYOVERVIEW_SORTING_IDNUMBER,
+            'categoryidnumber' => $this->sort == BLOCK_MYOVERVIEW_SORTING_CATEGORY_IDNUMBER,
         ];
         return array_merge($defaultvariables, $preferences);
 
diff --git a/public/blocks/myoverview/lang/en/block_myoverview.php b/public/blocks/myoverview/lang/en/block_myoverview.php
index 7fab9fa046f..9a8c81b4172 100644
--- a/public/blocks/myoverview/lang/en/block_myoverview.php
+++ b/public/blocks/myoverview/lang/en/block_myoverview.php
@@ -88,6 +88,7 @@ $string['sortbylastaccessed'] = 'Sort by last accessed';
 $string['sortbyshortname'] = 'Sort by short name';
 $string['sortbystartdate'] = 'Sort by start date';
 $string['sortbyidnumber'] = 'Course ID number';
+$string['sortbycategoryidnumber'] = 'Category ID number';
 $string['privacy:request:preference:set'] = 'The value of the setting \'{$a->name}\' was \'{$a->value}\'';
 $string['viewquickstart'] = 'View Quickstart guide';
 $string['zero_default_title'] = 'You\'re not enrolled in any courses.';
diff --git a/public/blocks/myoverview/lib.php b/public/blocks/myoverview/lib.php
index 49eab2c7983..76f03847aa6 100644
--- a/public/blocks/myoverview/lib.php
+++ b/public/blocks/myoverview/lib.php
@@ -50,6 +50,7 @@ define('BLOCK_MYOVERVIEW_SORTING_LASTACCESSED', 'lastaccessed');
 define('BLOCK_MYOVERVIEW_SORTING_SHORTNAME', 'shortname');
 define('BLOCK_MYOVERVIEW_SORTING_STARTDATE', 'startdate');
 define('BLOCK_MYOVERVIEW_SORTING_IDNUMBER', 'idnumber');
+define('BLOCK_MYOVERVIEW_SORTING_CATEGORY_IDNUMBER', 'categoryidnumber');
 
 
 /**
@@ -115,6 +116,7 @@ function block_myoverview_user_preferences(): array {
         BLOCK_MYOVERVIEW_SORTING_TITLE        => get_string('sortbytitle', 'block_myoverview'),
         BLOCK_MYOVERVIEW_SORTING_SHORTNAME    => get_string('sortbyshortname', 'block_myoverview'),
         BLOCK_MYOVERVIEW_SORTING_IDNUMBER     => get_string('sortbyidnumber', 'block_myoverview'),
+        BLOCK_MYOVERVIEW_SORTING_CATEGORY_IDNUMBER => get_string('sortbycategoryidnumber', 'block_myoverview'),
     ],
     'permissioncallback' => [core_user::class, 'is_current_user'],
 ];
diff --git a/public/blocks/myoverview/templates/nav-sort-selector.mustache b/public/blocks/myoverview/templates/nav-sort-selector.mustache
index 8e3e3a030c4..8f8815e3248 100644
--- a/public/blocks/myoverview/templates/nav-sort-selector.mustache
+++ b/public/blocks/myoverview/templates/nav-sort-selector.mustache
@@ -34,6 +34,7 @@
                 {{#lastaccessed}}{{#str}} sortbylastaccessed, block_myoverview {{/str}}{{/lastaccessed}}
                 {{#shortname}}{{#str}} sortbyshortname, block_myoverview {{/str}}{{/shortname}}
                 {{#startdate}}{{#str}} sortbystartdate, block_myoverview {{/str}}{{/startdate}}
+                {{#categoryidnumber}}{{#str}} sortbycategoryidnumber, block_myoverview {{/str}}{{/categoryidnumber}}
             </span>
         </button>
         <ul class="dropdown-menu" role="menu" data-show-active-item data-skip-active-class="true" aria-labelledby="sortingdropdown">
@@ -64,6 +65,11 @@
                     {{#str}} sortbyidnumber, block_myoverview {{/str}}
                  </a>
             </li>
+            <li>
+                <a class="dropdown-item" href="#" data-filter="sort" data-pref="categoryidnumber" data-value="categoryidnumber" aria-controls="courses-view-{{uniqid}}" role="menuitem" {{#categoryidnumber}}aria-current="true"{{/categoryidnumber}}>
+                    {{#str}} sortbycategoryidnumber, block_myoverview {{/str}}
+                 </a>
+            </li>
         </ul>
     </div>
 </div>
diff --git a/public/course/externallib.php b/public/course/externallib.php
index 9c48fdb563a..32c95254d9a 100644
--- a/public/course/externallib.php
+++ b/public/course/externallib.php
@@ -4071,6 +4071,11 @@ class core_course_external extends external_api {
         $limit = $params['limit'];
         $offset = $params['offset'];
         $sort = $params['sort'];
+        // Support sorting by category idnumber (the idnumber assigned to the course's category).
+        // Translate the token into an SQL expression that can be used in the ORDER BY.
+        if ($sort === 'categoryidnumber') {
+            $sort = "(SELECT cc.idnumber FROM {course_categories} cc WHERE cc.id = c.category)";
+        }
         $customfieldvalue = $params['customfieldvalue'];
         $searchvalue = clean_param($params['searchvalue'], PARAM_TEXT);
         $requiredfields = $params['requiredfields'];
-- 
2.48.1.windows.1

