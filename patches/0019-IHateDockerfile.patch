From f9f805460712d38a12ebc188abcb547aeaee408a Mon Sep 17 00:00:00 2001
From: GarethBouwer <itservices@bouwerandco.com>
Date: Wed, 4 Feb 2026 12:13:05 +0200
Subject: [PATCH 19/33] IHateDockerfile

---
 Dockerfile | 25 +++++++++++++++++++------
 1 file changed, 19 insertions(+), 6 deletions(-)

diff --git a/Dockerfile b/Dockerfile
index 1eb510dcdc0..59735bdc48a 100644
--- a/Dockerfile
+++ b/Dockerfile
@@ -1,9 +1,9 @@
 FROM php:8.3-apache
 
-# Enable Apache rewrite (required by Moodle for clean URLs)
+# Enable Apache rewrite (Moodle needs this)
 RUN a2enmod rewrite
 
-# Install system dependencies + PHP extensions needed by Moodle
+# System deps + PHP extensions required by Moodle 5.x
 RUN apt-get update && apt-get install -y \
     git \
     unzip \
@@ -17,6 +17,7 @@ RUN apt-get update && apt-get install -y \
     libonig-dev \
     libpq-dev \
     libldap2-dev \
+    composer \
  && docker-php-ext-configure gd --with-freetype --with-jpeg \
  && docker-php-ext-install \
         gd \
@@ -31,17 +32,21 @@ RUN apt-get update && apt-get install -y \
         ldap \
  && rm -rf /var/lib/apt/lists/*
 
-# App root
+# Moodle code root
 WORKDIR /var/www/html
 
-# Copy Moodle source into the image
+# Copy Moodle source
 COPY . /var/www/html
 
-# Moodle data directory (Railway volume mounts here)
+# Install Composer dependencies for Moodle (5.1+ requirement)
+# docs: composer install --no-dev --classmap-authoritative in Moodle root
+RUN composer install --no-dev --classmap-authoritative --no-interaction --prefer-dist
+
+# moodledata (Railway volume mounts here)
 RUN mkdir -p /var/www/moodledata \
  && chown -R www-data:www-data /var/www/html /var/www/moodledata
 
-# Configure Apache to serve only the /public directory (Moodle 5.x requirement)
+# Apache vhost: serve ONLY /public (Moodle 5.1+ requirement) and set ServerName
 RUN printf '%s\n' \
     '<VirtualHost *:80>' \
     '    ServerName localhost' \
@@ -53,4 +58,12 @@ RUN printf '%s\n' \
     '</VirtualHost>' \
     > /etc/apache2/sites-available/000-default.conf
 
+# Router + PHP max_input_vars via .htaccess in /public
+# - FallbackResource /r.php satisfies the Router check
+# - php_value max_input_vars 5000 satisfies the env check
+RUN printf '%s\n' \
+    'php_value max_input_vars 5000' \
+    'FallbackResource /r.php' \
+    >> /var/www/html/public/.htaccess
+
 EXPOSE 80
-- 
2.48.1.windows.1

